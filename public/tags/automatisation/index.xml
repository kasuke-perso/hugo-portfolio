<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Automatisation on Portfolio Florian</title>
    <link>/tags/automatisation/</link>
    <description>Recent content in Automatisation on Portfolio Florian</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>fr-fr</language>
    <lastBuildDate>Wed, 29 May 2019 14:29:12 +0200</lastBuildDate>
    <atom:link href="/tags/automatisation/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Gestion clÃ©s ssh Linux avec Ansible</title>
      <link>/blog/gestion-utilisateur-linux-avec-ansible/</link>
      <pubDate>Wed, 29 May 2019 14:29:12 +0200</pubDate>
      
      <guid>/blog/gestion-utilisateur-linux-avec-ansible/</guid>
      <description>

&lt;p&gt;Il arrive assez souvent de crÃ©er plein de VM ou de machine physique avec les mÃªmes utilisateurs qui vont s&amp;rsquo;en servir avec la mÃªme configuration.
Rajouter leur clÃ© ssh, Ãªtre dans le groupe admin, crÃ©er leur /home, etc&amp;hellip;&lt;/p&gt;

&lt;p&gt;Des tÃ¢ches rÃ©pÃ©titives qu&amp;rsquo;on aimerait bien automatiser. C&amp;rsquo;est pourquoi Ansible est lÃ  !&lt;/p&gt;

&lt;p&gt;Pour se faire, plusieurs mÃ©thodes s&amp;rsquo;offrent Ã  nous:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Faire de A Ã  Z un playbook avec le module &lt;a href=&#34;https://docs.ansible.com/ansible/latest/modules/user_module.html#user-module&#34;&gt;user&lt;/a&gt;, la doc d&amp;rsquo;ansible est plutÃ´t bien.&lt;/li&gt;
&lt;li&gt;Faire les flemmards et trouver un rÃ´le qui fasse tout Ã§a ðŸ˜Ž sur &lt;a href=&#34;https://galaxy.ansible.com/&#34;&gt;ansible galaxy&lt;/a&gt; ou github par exemple&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Les 2 options peuvent convenir, mais gÃ©nÃ©ralement les rÃ´les qu&amp;rsquo;il y a sur ansible galaxy sont prÃ©vus pour gÃ©rer tellement de cas que cela semble encore plus compliquÃ© de s&amp;rsquo;en servir que de le refaire sois-mÃªme.&lt;/p&gt;

&lt;p&gt;Donc aujourd&amp;rsquo;hui je vous propose ma solution qui va se servir d&amp;rsquo;un peu des deux car moi je veux un truc &lt;strong&gt;SIMPLE&lt;/strong&gt; et facile d&amp;rsquo;utilisation sans avoir Ã  replonger dans une doc pour s&amp;rsquo;en servir.&lt;/p&gt;

&lt;h3 id=&#34;petits-rappels:fa3f626fd3e78663e965dd70eef523d0&#34;&gt;Petits rappels&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Les rÃ´les sont situÃ©s dans votre /home &lt;code&gt;~/.ansible/roles&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Les variables passÃ©es dans &lt;code&gt;--extra-pass&lt;/code&gt; Ã©crasent toute celles que vous avez ailleurs&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;De base Ansible se sert des clÃ©s ssh pour communiquer, mais nous pouvons aussi utiliser un login mot de passe pour s&amp;rsquo;y connecter. Il faut alors rajouter &lt;code&gt;--ask-pass&lt;/code&gt; et quand on a besoin des droits &amp;lsquo;sudo&amp;rsquo; il faut aussi ajouter &lt;code&gt;--ask-become-pass&lt;/code&gt;.
En utilisant ask, lorsque vous lancerez votre playbook on vous demandera un mot de passe. Pour Ã©viter celÃ , on peut alors ajouter en variable &lt;code&gt;ansible_user=youruser&lt;/code&gt; et &lt;code&gt;ansible_password=yourpassword&lt;/code&gt; et &lt;code&gt;ansible_sudo_password=yourpassword&lt;/code&gt; pour les droits sudo.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;L&amp;rsquo;option &lt;code&gt;-i&lt;/code&gt; permet de prÃ©ciser quel fichier host utiliser (par dÃ©faut c&amp;rsquo;est &lt;code&gt;etc/ansible/hosts&lt;/code&gt;)&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;p&gt;Je vais partir de Ã§a &lt;a href=&#34;https://github.com/nickjj/ansible-user&#34;&gt;https://github.com/nickjj/ansible-user&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Je prÃ©cise qu&amp;rsquo;on est sur ubuntu server 18.04&lt;/p&gt;

&lt;p&gt;Il faut faire un petit &lt;code&gt;ansible-galaxy install nickjj.user&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Cela va crÃ©er un dossier dans votre &lt;code&gt;~/.ansible/roles&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;fdugat@SRV-ANSIBLE01:~/.ansible/roles/nickjj.user$ tree
.
â”œâ”€â”€ CHANGES.md
â”œâ”€â”€ defaults
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ LICENSE
â”œâ”€â”€ meta
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ README.md
â”œâ”€â”€ tasks
â”‚Â Â  â””â”€â”€ main.yml
â””â”€â”€ tests
    â””â”€â”€ test.yml
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Toute les variables sont dans&lt;/strong&gt; &lt;code&gt;defaults/main.yml&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Ce sera THE fichier Ã  modifier pour pouvoir l&amp;rsquo;adapter pour n&amp;rsquo;importe quel utilisateur.&lt;/p&gt;

&lt;h3 id=&#34;mais-ma-nouvelle-vm-ne-connait-pas-mes-clÃ©s-ssh-justement-comment-faire:fa3f626fd3e78663e965dd70eef523d0&#34;&gt;Mais ma nouvelle VM ne connait pas mes clÃ©s SSH justement ! Comment faire ?&lt;/h3&gt;

&lt;p&gt;HÃ© bien mon petit Jamie, il y a une option dans Ansible qui permet ce genre de chose. Je considÃ¨re que vous avez au moins un utilisateur qui peut se logger avec un mot de passe.&lt;/p&gt;

&lt;p&gt;Je vous conseil de faire Ã§a juste pour ce cas prÃ©cis. CrÃ©er un fichier dans votre &lt;code&gt;/home&lt;/code&gt; que vous nommerez &lt;code&gt;.ansible.cfg&lt;/code&gt;. Ce fichier contiendra des variables de configuration pour ansible qui seront propre Ã  un utilisateur (et non en global du coup)&lt;/p&gt;

&lt;p&gt;Dans ce fichier vous pouvez mettre ceci :&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;[defaults]&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;host_key_checking = False&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Ce qui aura pour consÃ©quence de ne pas vÃ©rifier le fichier known_hosts et ainsi rajouter une nouvelle machine sans vÃ©rif &amp;hellip; (pas bien)&lt;/p&gt;

&lt;p&gt;On peut rajouter des variables soit directement dans notre fichier &lt;code&gt;hosts&lt;/code&gt; (pas /etc/host hein) soit on peut les passer quand on Ã©xecute le playbook avec l&amp;rsquo;option &lt;code&gt;--extra-pass&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Exemple avec commande ansible-playbook:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;ansible-playbook -i hosts /
    --extra-vars &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;ansible_user=root / &lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    ansible_sudo_password=&amp;quot;&lt;/span&gt;yourpassword&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot; /&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    ansible_password=yourpassword&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;Contenu du fichier hosts:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;10&lt;/span&gt;.0.5.54 &lt;span style=&#34;color: #f8f8f2&#34;&gt;ansible_user&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;admin&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;ansible_password&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;yourpassword&amp;quot;&lt;/span&gt; / 
&lt;span style=&#34;color: #f8f8f2&#34;&gt;ansible_sudo_password&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;yourpassword&amp;quot;&lt;/span&gt; /
&lt;span style=&#34;color: #f8f8f2&#34;&gt;ansible_python_interpreter&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;/usr/bin/python3&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Si vous ne mettez pas &lt;code&gt;ansible_sudo_password&lt;/code&gt; vous aurez une erreur puisque dans le playbook on se sert des droits sudo.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>